name: Deploy to AWS

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build_uploads:
    runs-on: ubuntu-latest
    outputs:
      bucket_name: ${{ steps.capture.outputs.bucket }}
      cdn_url: ${{ steps.capture.outputs.cdn }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ fromJSON(secrets.AWS_CREDENTIALS).AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ fromJSON(secrets.AWS_CREDENTIALS).AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ fromJSON(vars.CONFIG_MAP).AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (uploads resources only)
        working-directory: iac
        env:
          AWS_REGION: ${{ fromJSON(vars.CONFIG_MAP).AWS_REGION }}
          BUCKET_NAME: ${{ vars.BUCKET_NAME }}
        run: terraform init -reconfigure -backend-config="bucket=$BUCKET_NAME" \
            -backend-config="region=$AWS_REGION" \
            -backend-config="encrypt=true"

      - name: Terraform Plan (uploads only)
        working-directory: iac
        run: |
          terraform plan \
            -target=aws_s3_bucket.uploads \
            -target=aws_s3_bucket_public_access_block.uploads_public_access \
            -target=aws_s3_bucket_policy.uploads_public_policy \
            -target=aws_cloudfront_distribution.uploads_cdn \
            -out=tfplan_uploads

      - name: Terraform Apply (uploads only)
        working-directory: iac
        run: terraform apply -auto-approve tfplan_uploads

      - name: Capture TF Outputs
        id: capture
        working-directory: iac
        run: |
          echo "bucket=$(terraform output -raw uploads_bucket_name)" >> $GITHUB_OUTPUT
          echo "cdn=$(terraform output -raw uploads_cdn_url)" >> $GITHUB_OUTPUT

  build_images:
    needs: build_uploads
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push images dynamically
        run: |
          cd microsservicos
          for dir in */ ; do
            service=$(basename "$dir")
           if [ "$service" = "kubernetes" ] || [ "$service" = "aluguel_ts" ]; then
              echo "â­ï¸ Skipping folder: $service"
              continue
            fi

            echo "ðŸš€ Building image for service: $service"

            docker buildx build \
              --platform=linux/amd64 \
              -t victorgasperi/workup-$service \
              ./$service \
              --push
          done

  deploy_ec2:
    needs: 
      - build_uploads
      - build_images
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref_name }}
    env:
      TF_VAR_repo_url: https://github.com/${{ github.repository }}.git
      TF_VAR_stage: ${{ github.ref_name }}
      TF_VAR_config_map: ${{ vars.CONFIG_MAP }}
      TF_VAR_secret_map: ${{ secrets.SECRET_MAP }}
      TF_VAR_key_name: ${{ vars.KEY_NAME }}
      TF_VAR_ssh_cidr: ${{ secrets.SSH_CIDR }}

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build dynamic CONFIG_MAP (add S3/CDN from job1)
        run: |
          echo "TF_VAR_config_map=$(jq -n \
            --argjson base '${{ vars.CONFIG_MAP }}' \
            --arg bucket '${{ needs.build_uploads.outputs.bucket_name }}' \
            --arg cdn '${{ needs.build_uploads.outputs.cdn_url }}' \
            '$base + { S3_BUCKET: $bucket, CDN_DOMAIN: $cdn }')" >> $GITHUB_ENV

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ fromJSON(secrets.AWS_CREDENTIALS).AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ fromJSON(secrets.AWS_CREDENTIALS).AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ fromJSON(vars.CONFIG_MAP).AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (EC2)
        working-directory: iac
        env:
          AWS_REGION: ${{ fromJSON(vars.CONFIG_MAP).AWS_REGION }}
          BUCKET_NAME: ${{ vars.BUCKET_NAME }}
        run: terraform init -reconfigure -backend-config="bucket=$BUCKET_NAME" \
            -backend-config="region=$AWS_REGION" \
            -backend-config="encrypt=true"

      - name: Terraform Apply (EC2)
        working-directory: iac
        run: terraform apply -auto-approve